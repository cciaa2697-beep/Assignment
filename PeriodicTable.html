<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Periodic Table 3D</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        #container { position: fixed; inset: 0; }

        /* Profile button top-right */
        #profile-container {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            font-family: sans-serif;
            color: white;
        }
        #profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
        }
        #user-name {
            color: white;
            font-weight: bold;
        }
        #sign-out-btn {
            padding: 5px 10px;
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        #sign-out-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        /* Buttons for layouts */
        #menu {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            z-index: 500;
        }
        button {
            color: rgba(127,255,255,0.75);
            background: transparent;
            outline: 1px solid rgba(127,255,255,0.75);
            border: 0px;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            margin: 0 5px;
        }
        button:hover {
            background-color: rgba(0,255,255,0.5);
        }
        button:active {
            color: #000000;
            background-color: rgba(0,255,255,0.75);
        }
    </style>
</head>
<body>

    <!-- Profile Button -->
    <div id="profile-container">
        <img id="profile-pic" src="" alt="Profile">
        <span id="user-name">User</span>
        <button id="sign-out-btn">Sign Out</button>
    </div>

    <div id="container"></div>
    <div id="menu">
        <button id="table">TABLE</button>
        <button id="sphere">SPHERE</button>
        <button id="helix">HELIX</button>
        <button id="grid">GRID</button>
    </div>

    <script>
        // Show profile info if token exists
        const token = sessionStorage.getItem('access_token');
        const profilePic = document.getElementById('profile-pic');
        const userName = document.getElementById('user-name');
        const signOutBtn = document.getElementById('sign-out-btn');

        if (!token) {
            // Not signed in, redirect to login
            window.location.href = 'index.html';
        } else {
            // Fetch user info from Google
            fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => res.json())
            .then(user => {
                profilePic.src = user.picture || '';
                userName.textContent = user.name || 'User';
            })
            .catch(err => {
                console.warn('Failed to load user info', err);
                userName.textContent = 'User';
                profilePic.src = '';
            });
        }

        // Sign out button clears token and redirects
        signOutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('access_token');
            window.location.href = 'index.html';
        });
    </script>

    <!-- Your existing Periodic Table 3D scripts go here -->
    <script type="module" src="your_existing_periodictable_module.js"></script>

</body>
</html>

    <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.module.js';
    import { CSS3DRenderer, CSS3DObject } from 'https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/renderers/CSS3DRenderer.js';
    import { TrackballControls } from 'https://cdn.jsdelivr.net/npm/three@0.152.0/examples/jsm/controls/TrackballControls.js';
    import * as TWEEN from 'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.esm.js';

    let camera, scene, renderer, controls;
    const objects = [];
    const targets = { table: [], sphere: [], helix: [], grid: [] };

    async function waitForTableData(timeout = 8000) {
        const start = Date.now();
        while (!window.TABLE_DATA) {
            if (Date.now() - start > timeout) return null;
            await new Promise(r => setTimeout(r, 50));
        }
        return window.TABLE_DATA;
    }

    waitForTableData().then(data => {
        if (!data) {
            document.getElementById('container').innerHTML = '<div style="padding:20px;color:#fff;">No table data loaded.</div>';
            return;
        }
        init();
        animate();
    });

    function init() {
        camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 1, 10000);
        camera.position.z = 3000;
        scene = new THREE.Scene();

        const table = window.TABLE_DATA;

        function parseMoney(s){
            if(!s) return null;
            s = s.replace(/^\(+|\)+$/g,'').replace(/[^0-9kKmM\.,-]/g,'').trim();
            let mult = 1;
            if(/[kK]$/.test(s)){ mult=1e3; s=s.replace(/[kK]$/,''); }
            if(/[mM]$/.test(s)){ mult=1e6; s=s.replace(/[mM]$/,''); }
            const n = parseFloat(s.replace(/,/g,''));
            return isNaN(n)?null:n*mult;
        }

        // Create elements
        for(let i=0;i<table.length;i+=6){
            const element = document.createElement('div');
            element.className='element';

            let net = null;
            const candidates = [table[i+5], table[i+4], table[i+3], table[i+2]];
            for(const c of candidates){ const n=parseMoney(c); if(n!==null){net=n; break;} }

            if(net===null) element.style.backgroundColor = 'rgba(0,127,127,'+(Math.random()*0.5+0.25)+')';
            else if(net<100000) element.style.backgroundColor='#d9534f';
            else if(net<=200000) element.style.backgroundColor='#f0ad4e';
            else element.style.backgroundColor='#5cb85c';

            const name = document.createElement('div'); name.className='name'; name.textContent=table[i]; element.appendChild(name);
            const photo = document.createElement('img'); photo.className='photo'; photo.src=table[i+1]; element.appendChild(photo);
            const age = document.createElement('div'); age.className='age'; age.textContent=table[i+2]; element.appendChild(age);
            const country = document.createElement('div'); country.className='country'; country.textContent=table[i+3]; element.appendChild(country);
            const interest = document.createElement('div'); interest.className='interest'; interest.textContent=table[i+4]; element.appendChild(interest);

            const objCSS = new CSS3DObject(element);
            objCSS.position.x = Math.random()*4000-2000;
            objCSS.position.y = Math.random()*4000-2000;
            objCSS.position.z = Math.random()*4000-2000;
            scene.add(objCSS);
            objects.push(objCSS);

            const obj = new THREE.Object3D();
            const index = i/6;
            const cols=20, rows=10, spacingX=140, spacingY=180;
            obj.position.x = (index%cols)*spacingX - ((cols-1)*spacingX)/2;
            obj.position.y = -(Math.floor(index/cols)*spacingY) + ((rows-1)*spacingY)/2;
            targets.table.push(obj);
        }

        // Sphere
        const vector = new THREE.Vector3();
        for(let i=0,l=objects.length;i<l;i++){
            const phi=Math.acos(-1+2*i/l);
            const theta=Math.sqrt(l*Math.PI)*phi;
            const obj=new THREE.Object3D();
            obj.position.setFromSphericalCoords(800, phi, theta);
            vector.copy(obj.position).multiplyScalar(2);
            obj.lookAt(vector);
            targets.sphere.push(obj);
        }

        // Helix
        for(let i=0,l=objects.length;i<l;i++){
            const theta=i*0.175+Math.PI;
            const y=-i*8+450;
            const obj=new THREE.Object3D();
            const offset=(i%2===0)?0:Math.PI;
            obj.position.setFromCylindricalCoords(900, theta+offset, y);
            vector.x=obj.position.x*2;
            vector.y=obj.position.y;
            vector.z=obj.position.z*2;
            obj.lookAt(vector);
            targets.helix.push(obj);
        }

        // Grid
        for(let i=0;i<objects.length;i++){
            const obj=new THREE.Object3D();
            obj.position.x=(i%5)*400-800;
            obj.position.y=-(Math.floor(i/5)%4)*400+800;
            obj.position.z=Math.floor(i/20)*1000-2000;
            targets.grid.push(obj);
        }

        renderer = new CSS3DRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);

        controls = new TrackballControls(camera, renderer.domElement);
        controls.minDistance = 900;
        controls.maxDistance = 16000;
        controls.addEventListener('change', render);

        document.getElementById('table').addEventListener('click', ()=>transform(targets.table,2000));
        document.getElementById('sphere').addEventListener('click', ()=>transform(targets.sphere,2000));
        document.getElementById('helix').addEventListener('click', ()=>transform(targets.helix,2000));
        document.getElementById('grid').addEventListener('click', ()=>transform(targets.grid,2000));

        transform(targets.table,2000);
        window.addEventListener('resize', onWindowResize);
    }

    function transform(targets, duration){
        TWEEN.removeAll();
        for(let i=0;i<objects.length;i++){
            const obj=objects[i], target=targets[i];
            new TWEEN.Tween(obj.position).to({x:target.position.x,y:target.position.y,z:target.position.z},Math.random()*duration+duration).easing(TWEEN.Easing.Exponential.InOut).start();
            new TWEEN.Tween(obj.rotation).to({x:target.rotation.x,y:target.rotation.y,z:target.rotation.z},Math.random()*duration+duration).easing(TWEEN.Easing.Exponential.InOut).start();
        }
        new TWEEN.Tween(this).to({}, duration*2).onUpdate(render).start();
    }

    function onWindowResize(){
        camera.aspect=window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        render();
    }

    function animate(){
        requestAnimationFrame(animate);
        TWEEN.update();
        controls.update();
    }

    function render(){
        renderer.render(scene,camera);
    }
    </script>
</body>
</html>
